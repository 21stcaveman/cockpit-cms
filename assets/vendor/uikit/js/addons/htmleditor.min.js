/*! UIkit 2.6.0 | http://www.getuikit.com | (c) 2014 YOOtheme | MIT License */

(function(t){"function"==typeof define&&define.amd&&define("uikit-htmleditor",["uikit"],function(){return jQuery.UIkit.htmleditor||t(window,window.jQuery,window.jQuery.UIkit)}),window&&window.jQuery&&window.jQuery.UIkit&&t(window,window.jQuery,window.jQuery.UIkit)})(function(t,e,i){var n=function(t,i){var o=e(t);o.data("htmleditor")||(this.element=o,this.options=e.extend(!0,{},n.defaults,i),this.marked=this.options.marked||marked,this.CodeMirror=this.options.CodeMirror||CodeMirror,this.init(),this.element.data("htmleditor",this))};e.extend(n.prototype,{init:function(){var t=this,o=n.template;this.options.markdown&&(this.options.codemirror.mode="gfm"),o=o.replace(/\{\:lblPreview\}/g,this.options.lblPreview),o=o.replace(/\{\:lblCodeview\}/g,this.options.markdown?"Markdown":this.options.lblCodeview),this.htmleditor=e(o),this.content=this.htmleditor.find(".uk-htmleditor-content"),this.toolbar=this.htmleditor.find(".uk-htmleditor-toolbar"),this.preview=this.htmleditor.find(".uk-htmleditor-preview").children().eq(0),this.code=this.htmleditor.find(".uk-htmleditor-code"),this.element.before(this.htmleditor).appendTo(this.code),this.editor=this.CodeMirror.fromTextArea(this.element[0],this.options.codemirror),this.editor.htmleditor=this,this.editor.on("change",function(){var e=function(){t.render()};return i.Utils.debounce(e,150)}()),this.code.find(".CodeMirror").css("height",this.options.height),e(window).on("resize",i.Utils.debounce(function(){t.fit()},200));var s=t.preview.parent(),a=this.code.find(".CodeMirror-sizer"),r=this.code.find(".CodeMirror-scroll").on("scroll",i.Utils.debounce(function(){if("tab"!=t.htmleditor.attr("data-mode")){var e=a.height()-r.height(),i=s[0].scrollHeight-s.height(),n=i/e,o=r.scrollTop()*n;s.scrollTop(o)}},10));this.htmleditor.on("click",".uk-htmleditor-button-code, .uk-htmleditor-button-preview",function(i){i.preventDefault(),"tab"==t.htmleditor.attr("data-mode")&&(t.htmleditor.find(".uk-htmleditor-button-code, .uk-htmleditor-button-preview").removeClass("uk-active").filter(this).addClass("uk-active"),t.activetab=e(this).hasClass("uk-htmleditor-button-code")?"code":"preview",t.htmleditor.attr("data-active-tab",t.activetab))}),this.htmleditor.on("click","a[data-htmleditor-cmd]",function(){var i=e(this).data("htmleditorCmd");!i||!n.commands[i]||t.activetab&&"code"!=t.activetab&&"fullscreen"!=i||n.commands[i].action.apply(t,[t.editor])}),this.preview.parent().css("height",this.code.height()),this.options.autocomplete&&this.CodeMirror.showHint&&this.CodeMirror.hint&&this.CodeMirror.hint.html&&this.editor.on("inputRead",i.Utils.debounce(function(){var e=t.editor.getDoc(),i=e.getCursor(),n=t.CodeMirror.innerMode(t.editor.getMode(),t.editor.getTokenAt(i).state).mode.name;if("xml"==n){var o=t.editor.getCursor(),s=t.editor.getTokenAt(o);("<"==s.string.charAt(0)||"attribute"==s.type)&&t.CodeMirror.showHint(t.editor,t.CodeMirror.hint.html,{completeSingle:!1})}},100)),this.element.on({enableMarkdown:function(){t.enableMarkdown()},disableMarkdown:function(){t.disableMarkdown()}}),this.redraw()},applyPlugins:function(){var t=this,e=this.options.plugins||[],i=n.plugins;if(this.markers={},e.length){var o=this.currentvalue.split("\n");e.forEach(function(t){this.markers[t]=[]},this);for(var s=0,a=o.length;a>s;s++)(function(n){e.forEach(function(e){var s=0;o[n]=o[n].replace(i[e].identifier,function(){var o=i[e].cb({editor:t,found:arguments,line:n,pos:s++,uid:[e,n,s,(new Date).getTime()+"RAND"+Math.ceil(1e5*Math.random())].join("-"),replace:function(t){var e=this.editor.editor.getLine(this.line),i=e.indexOf(this.found[0]);end=i+this.found[0].length,this.editor.editor.replaceRange(t,{line:this.line,ch:i},{line:this.line,ch:end})}});return o})})})(s);this.currentvalue=o.join("\n")}},_buildtoolbar:function(){if(this.options.toolbar&&this.options.toolbar.length){var t=this,e=[];this.toolbar.empty(),this.editor.removeKeyMap("htmleditor"),this.options.toolbar.forEach(function(i){if(n.commands[i]){var o=n.commands[i].title?n.commands[i].title:i;e.push('<li><a data-htmleditor-cmd="'+i+'" title="'+o+'" data-uk-tooltip>'+n.commands[i].label+"</a></li>"),n.commands[i].shortcut&&t.registerShortcut(n.commands[i].shortcut,n.commands[i].action)}}),this.toolbar.html(e.join("\n"))}},fit:function(){var t=this.options.mode;"split"==t&&this.htmleditor.width()<this.options.maxsplitsize&&(t="tab"),"tab"==t&&(this.activetab||(this.activetab="code",this.htmleditor.attr("data-active-tab",this.activetab)),this.htmleditor.find(".uk-htmleditor-button-code, .uk-htmleditor-button-preview").removeClass("uk-active").filter("code"==this.activetab?".uk-htmleditor-button-code":".uk-htmleditor-button-preview").addClass("uk-active")),this.editor.refresh(),this.preview.parent().css("height",this.code.height()),this.htmleditor.attr("data-mode",t)},redraw:function(){this._buildtoolbar(),this.render(),this.fit()},registerShortcut:function(t,i){for(var n=this,o=!1,s=this.editor.state.keyMaps,a=0;s.length>a;++a)if(s[a]&&"htmleditor"==s[a].name){o=s[a];break}o||(o={name:"htmleditor"},this.editor.addKeyMap(o)),t=e.isArray(t)?t:[t];for(var a=0,r=t.length;r>a;a++)o[t[a]]=function(){i.apply(n,[n.editor])}},getMode:function(){if("gfm"==this.editor.options.mode){var t=this.editor.getDoc().getCursor();return this.editor.getTokenAt(t).state.base.htmlState?"html":"markdown"}return"html"},render:function(){var t=this,i=this.editor.getValue();if(this.currentvalue=i+"",this.element.trigger("htmleditor-before",[this]),this.applyPlugins(),"gfm"==this.editor.options.mode&&this.marked)this.marked.setOptions(this.options.markedOptions),this.marked(t.currentvalue,function(e,i){if(e)throw e;t.preview.html(i),t.element.val(t.editor.getValue()).trigger("htmleditor-update",[t])});else{var n=e.parseHTML(t.currentvalue);n&&n.length&&(this.preview.html(n),this.element.val(this.editor.getValue()).trigger("htmleditor-update",[t]))}},enableMarkdown:function(){this.editor.setOption("mode","gfm"),this.htmleditor.find(".uk-htmleditor-button-code a").html("Markdown"),this.render()},disableMarkdown:function(){this.editor.setOption("mode","htmlmixed"),this.htmleditor.find(".uk-htmleditor-button-code a").html(this.options.lblCodeview),this.render()}});var o=function(t,e){var i=e.getSelection();if(!i.length){for(var n=e.getCursor(),o=e.getLine(n.line),s=n.ch,a=s;o.length>a&&/[\w$]+/.test(o.charAt(a));)++a;for(;s&&/[\w$]+/.test(o.charAt(s-1));)--s;var r=s!=a&&o.slice(s,a);r&&(e.setSelection({line:n.line,ch:s},{line:n.line,ch:a}),i=r)}var l=t.replace("$1",i);e.replaceSelection(l,"end"),e.focus()},s=function(t,e){var i=e.getDoc().getCursor(),n=e.getLine(i.line),o=t.replace("$1",n);e.replaceRange(o,{line:i.line,ch:0},{line:i.line,ch:n.length}),e.setCursor({line:i.line,ch:o.length}),e.focus()};return n.commands={fullscreen:{title:"Fullscreen",label:'<i class="uk-icon-expand"></i>',action:function(t){t.htmleditor.htmleditor.toggleClass("uk-htmleditor-fullscreen");var e=t.getWrapperElement();if(t.htmleditor.htmleditor.hasClass("uk-htmleditor-fullscreen"))t.state.fullScreenRestore={scrollTop:window.pageYOffset,scrollLeft:window.pageXOffset,width:e.style.width,height:e.style.height},e.style.width="",e.style.height=t.htmleditor.content.height()+"px",document.documentElement.style.overflow="hidden";else{document.documentElement.style.overflow="";var i=t.state.fullScreenRestore;e.style.width=i.width,e.style.height=i.height,window.scrollTo(i.scrollLeft,i.scrollTop)}t.refresh(),t.htmleditor.preview.parent().css("height",t.htmleditor.code.height())}},bold:{title:"Bold",label:'<i class="uk-icon-bold"></i>',shortcut:["Ctrl-B","Cmd-B"],action:function(t){o("html"==this.getMode()?"<strong>$1</strong>":"**$1**",t)}},italic:{title:"Italic",label:'<i class="uk-icon-italic"></i>',action:function(t){o("html"==this.getMode()?"<em>$1</em>":"*$1*",t)}},strike:{title:"Strikethrough",label:'<i class="uk-icon-strikethrough"></i>',action:function(t){o("html"==this.getMode()?"<del>$1</del>":"~~$1~~",t)}},blockquote:{title:"Blockquote",label:'<i class="uk-icon-quote-right"></i>',action:function(t){s("html"==this.getMode()?"<blockquote><p>$1</p></blockquote>":"> $1",t)}},link:{title:"Link",label:'<i class="uk-icon-link"></i>',action:function(t){o("html"==this.getMode()?'<a href="http://">$1</a>':"[$1](http://)",t)}},picture:{title:"Picture",label:'<i class="uk-icon-picture-o"></i>',action:function(t){o("html"==this.getMode()?'<img src="http://" alt="$1">':"![$1](http://)",t)}},listUl:{title:"Unordered List",label:'<i class="uk-icon-list-ul"></i>',action:function(t){"markdown"==this.getMode()&&s("* $1",t)}},listOl:{title:"Ordered List",label:'<i class="uk-icon-list-ol"></i>',action:function(t){"markdown"==this.getMode()&&s("1. $1",t)}}},n.defaults={mode:"split",markdown:!1,autocomplete:!0,height:500,plugins:[],maxsplitsize:1e3,markedOptions:{gfm:!0,tables:!0,breaks:!0,pedantic:!0,sanitize:!1,smartLists:!0,smartypants:!1,langPrefix:"lang-"},codemirror:{mode:"htmlmixed",tabMode:"indent",tabindex:"4",lineWrapping:!0,dragDrop:!1,autoCloseTags:!0,matchTags:!0,autoCloseBrackets:!0,matchBrackets:!0},toolbar:["bold","italic","strike","link","picture","blockquote","listUl","listOl"],lblPreview:"Preview",lblCodeview:"HTML"},n.template='<div class="uk-htmleditor uk-clearfix" data-mode="split"><div class="uk-htmleditor-navbar"><ul class="uk-htmleditor-navbar-nav uk-htmleditor-toolbar"></ul><div class="uk-htmleditor-navbar-flip"><ul class="uk-htmleditor-navbar-nav"><li class="uk-htmleditor-button-code"><a>{:lblCodeview}</a></li><li class="uk-htmleditor-button-preview"><a>{:lblPreview}</a></li><li><a data-htmleditor-cmd="fullscreen"><i class="uk-icon-expand"></i></a></li></ul></div></div><div class="uk-htmleditor-content"><div class="uk-htmleditor-code"></div><div class="uk-htmleditor-preview"><div></div></div></div></div>',n.plugins={},n.addPlugin=function(t,e,i){n.plugins[t]={identifier:e,cb:i}},i.htmleditor=n,e(function(){e("textarea[data-uk-htmleditor]").each(function(){var t,o=e(this);o.data("htmleditor")||(t=new n(o,i.Utils.options(o.attr("data-uk-htmleditor"))))})}),n});